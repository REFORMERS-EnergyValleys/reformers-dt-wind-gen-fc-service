# This file defines the pipelineâ€™s jobs, stages, and rules for automatically building
# and deploying this RDP setup for the REFORMERS Digital Twin with GitLab CI/CD.
#
# The following CI/CD variables are expected (cp. with file .env.example):
# - MODEL_API_BASE_URL: URL for Model API
# - MODEL_API_TOKEN: token for accessing the Model API
# - MODEL_IMAGE_REGISTRY: name of container registry for model images
# - DOCKER_AUTH_CONFIG (variable of type File): credential file for docker registries (base64-encoded user name and passwords)
# - REDIS_PASSWORD: password for redis
# - DATA_CRAWLER_CONTACT: contact email for the data crawler service
# - POSTGRES_DB: name of the postgres database
# - POSTGRES_ADMIN_USER: user name for the postgres database
# - POSTGRES_ADMIN_PASSWORD: password for the postgres database
# - POSTGRES_DATA_SOURCE_USER: user name for the postgres data source role
# - POSTGRES_DATA_SOURCE_PASSWORD: password for the postgres data source role
# - POSTGRES_DATA_VIS_USER: user name for the postgres internal visualization role
# - POSTGRES_DATA_VIS_PASSWORD: password for the postgres internal visualization role
# - POSTGRES_DATA_PUB_VIS_USER: user name for the postgres public visualization role
# - POSTGRES_DATA_PUB_VIS_PASSWORD: password for the postgres public visualization role
# - GRAFANA_ADMIN_USER: user name for the internal monitoring instance
# - GRAFANA_ADMIN_PASSWORD: password for the internal monitoring instance

stages:
  - setup
  - generate-model
  - staging

# ============================================================================
# Setup for docker (provide credentials for registries)
# ============================================================================
docker-setup:
  stage: setup
  before_script:
    # Install requirements
    - apt-get -y --no-upgrade --no-install-recommends --no-install-suggests install jq bash coreutils
  script:
    - |
      ### Setup for docker (provide credentials for registries)

      # Check if input file is well formatted
      if ! jq -e 'has("auths") and (.auths | type == "object") and all(.[] | has("auth"))' "${DOCKER_AUTH_CONFIG}" >/dev/null; then
        echo "[ERROR] file ${DOCKER_AUTH_CONFIG} is not well formatted"
        exit 1
      fi

      # Path to Docker config
      DOCKER_CONFIG_JSON=${HOME}/.docker/config.json

      # Flag to check if the config needs an update
      UPDATE_CONFIG=false

      # Check if all registries provided via file DOCKER_AUTH_CONFIG are already known
      NEW_REGISTRIES=$(jq -r '.auths | keys[]' "${DOCKER_AUTH_CONFIG}" | sed -E 's|^https?://||')
      for REGISTRY in ${NEW_REGISTRIES}; do
          if ! jq -e --arg reg "${REGISTRY}" '.auths | has($reg)' "${DOCKER_CONFIG_JSON}" >/dev/null; then
              echo "[INFO] ${REGISTRY} will be added"
              UPDATE_CONFIG=true
          else
              echo "[INFO] ${REGISTRY} already known"
          fi
      done

      # Merge configs if needed
      if [ "${UPDATE_CONFIG}" = true ]; then
          DOCKER_CONFIG_JSON_UPDATE=$(jq -s '.[0] * .[1]' "${DOCKER_CONFIG_JSON}" "${DOCKER_AUTH_CONFIG}")
          echo "${DOCKER_CONFIG_JSON_UPDATE}" > "${DOCKER_CONFIG_JSON}"
          echo "[INFO] Merged Docker configs:"
          cat "${DOCKER_CONFIG_JSON}"
      fi
  tags:
    - reformers-dev
  rules:
    - when: on_success

# ============================================================================
# Use the Model API Helper to generate the model and a separate .env file
# containg all required environment variables
# ============================================================================

model-api-helper:
  image: ghcr.io/reformers-energyvalleys/model-api-helper:release
  script: model-deploy
  variables:
    MODEL_REQUEST: ./wind-gen-fc/model-request.yaml
    MODEL_ENV_OUTPUT: ./wind-gen-fc/model.env
  artifacts:
    paths:
      - ./wind-gen-fc/model.env
  stage: generate-model
  tags:
    - docker

# ============================================================================
# Define job template for deploying the model API & container registry
# ============================================================================
.deploy-example-rdp:
  script:
    - docker info
    - docker compose pull --quiet
    - docker compose build --pull
    - docker compose up --force-recreate --always-recreate-deps -d

# ============================================================================
# Staging Jobs
# ============================================================================

deploy-example-rdp:
  extends: .deploy-example-rdp
  stage: staging
  dependencies:
    - model-api-helper
  tags:
    - reformers-dev
  rules:
    - when: on_success
